---
title: "CoStar Interactive"

output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    vertical_layout: scroll
runtime: shiny
---

```{r load-packages, include=FALSE}
library(flexdashboard)
library(shiny)
library(tidyverse)
library(broom)
library(dplyr)
library(lubridate)
library(stringr)
library(tidytext)
library(textdata)
library(SnowballC)
library(DT)
```

```{r load-data, include = FALSE}
data <- read_csv("data.csv") %>%
  as.tibble()

data <- data %>%
  mutate(dateTime = ymd_hms(CreatedDate),
         Year = year(dateTime),
         Month = month(dateTime),
         Day = day(dateTime),
         Date = paste(Year, Month, Day, sep = "-") %>% ymd() %>% as.Date()) %>%
  select(-dateTime, -Day, -Month, -Year) %>%
  select(Date, everything()) %>%
  mutate(Title = as.character(Title), 
         Summary = as.character(Summary),
         Body = as.character(Body))
```

```{r more-cleaning, include = FALSE}
allTags <- gather(data, "tags", "hasTag", 13:35) 
allTags <- allTags[order(allTags$StoryID),]

# creates a dataframe with story titles and their tag counts
tagCounts <- allTags %>%
  group_by(StoryID) %>%
  count(hasTag == 1) %>%
  select(StoryID, n) %>%
  rename(numTags = n)

# previous operation returns both true and false, removing all FALSE
toDelete <- seq(1, nrow(tagCounts), 2)
tagCounts <- tagCounts[-toDelete, ]

data <- data %>%
  full_join(tagCounts)
```


Sidebar {.sidebar}
=======================================================================

### Story characteristics

```{r chooseTags}
hr()
selectInput("tag", "Choose desired tags:",
                  list(`RealEstate` = list("Development", "Land", "Lease", "MixedUse", "Retail", "Sale", "SpecialPurpose"),
                       `Workforce` = list("Company", "CompaniesPeople", "Office"),
                       `Business` = list("Analytics", "Finance", "Investment"),
                       `PublicServices` = list("Healthcare", "Hospitality", "Multifamily", "People", "PublicSector"),
                       `Sectors/Misc` = list("Events", "Industrial", "Legal", "National")
                  ),
                  selected = list("Development", "Company", "Analytics", "Healthcare"),
                  multiple = TRUE)
```



```{r chooseCountry}
hr()

checkboxGroupInput(inputId = "country",
                         label = "Select countries:",
                         choices = c("Canada", "US", "GB") ,
                         selected = "US")
```


```{r chooseDateRange}
hr()

sliderInput("TheDates",
                    "Move the sliders to select a date range:",
                    min = as.Date("2016-03-31","%Y-%m-%d"),
                    max = as.Date("2018-09-28","%Y-%m-%d"),
                    value=c(as.Date("2017-04-05"), as.Date("2018-04-13")),
                    timeFormat=("%Y-%m-%d"))
```



```{r makeReactive}
hr()

sel_data <- reactive({
data %>%
    drop_na() %>%
    select(-Body) %>%
    filter(
      between(Date, input$TheDates[1], input$TheDates[2])
      )
})
```


Dashboard
=======================================================================

Row
-----------------------------------------------------------------------

### Average number of hits per story {.value-box}

```{r avg-hitsPerStory}
renderValueBox({
  valueBox(value = round(mean(sel_data()$Hits, na.rm = TRUE), 2))
})
```

### Average number of tags per story {.value-box}

```{r avg-tagsPerStory}
renderValueBox({
  valueBox(value = round(mean(sel_data()$numTags, na.rm = TRUE), 2))
})
```

### Total number of stories {.value-box}
```{r totalStory}
renderValueBox({
  valueBox(value = count(sel_data()))
})

```

Row
-----------------------------------------------------------------------

### Visualization {data-width=700}

```{r word-freq-viz}
plotData <- reactive({ 
  data %>%
  drop_na() %>%
    select(-Body) %>%
    filter(
      between(Date, input$TheDates[1], input$TheDates[2])
      ) %>%
  select(Date, Title, StoryID) %>%
  unnest_tokens(word, Title) %>%
  anti_join(stop_words) %>%
  count(word, sort = TRUE)
})

#plotData()$word <- factor(textFreq$word, levels = textFreq$word[order(desc((textFreq$n)))])
```

```{r plot_rendering}
renderPlot({
  plotData() %>%
    slice(0:10) %>%
  ggplot(aes(x = reorder(word, -n), y = n)) +
    geom_col() +
  labs(x = "Words", y = "Frequency", title = "Most frequent words in Titles")
  })
```

Data
=======================================================================

### About the data {data-width=100}

This [flexdashboard](https://rmarkdown.rstudio.com/flexdashboard/) uses data 
from CoStar.

The data used in the analysis is shown below.

```{r data-table}
renderDataTable({
  datatable(sel_data() %>%
               select(-(11:34))
             ) 
})
```